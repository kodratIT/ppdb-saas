# Story 2.5.3: Update All Permission Checking Helpers

Status: ready-for-dev

## Story

As a Developer,
I want to implement a comprehensive RBAC permission system with Firebase role mapping, fine-grained authorization checks, and audit logging,
so that all admin routes have proper permission-based access control and security events are tracked.

## Acceptance Criteria

1. **Firebase Custom Claims mapped to PPDB roles** - Firebase user records include custom claims that map to PPDB user roles (super_admin, school_admin, verifier, treasurer, parent)
2. **Comprehensive RBAC permission matrix documented** - All permissions for each role defined in a centralized location with clear business rules
3. **Permission checking helpers implemented** - Create helper functions for each permission type (read, write, admin, etc.) with role-based validation
4. **Audit logging for authorization events** - All authorization failures and sensitive actions logged to audit_logs table
5. **Admin routes updated with permission-based access control** - All server actions use permission helpers instead of basic role checks
6. **Integration tests for permission checking** - Tests cover all role permissions and authorization edge cases

## Tasks / Subtasks

- [ ] **Task 1: Define RBAC Permission Matrix** (AC: 2)
  - [ ] Create permission definitions at `src/lib/server/auth/permissions.ts`:
    - [ ] Define all permission categories (tenant_read, tenant_write, admin_full_access, etc.)
    - [ ] Map each role to their allowed permissions
    - [ ] Document business rules for each permission
    - [ ] Define Super Admin global permissions (no tenant restriction)
    - [ ] Define tenant-scoped permissions (school_admin, verifier, treasurer, parent)
  - [ ] Create helper function `hasPermission(role: UserRole, permission: string): boolean`
  - [ ] Create helper function `getPermissionsForRole(role: UserRole): string[]`

- [ ] **Task 2: Enhance Authorization Helpers** (AC: 1, 3)
  - [ ] Update `src/lib/server/auth/authorization.ts`:
    - [ ] Enhance `requireRole()` to use permission matrix
    - [ ] Add `requirePermission(...permissions)` - checks if user has ANY of the specified permissions
    - [ ] Add `requireAllPermissions(...permissions)` - checks if user has ALL specified permissions
    - [ ] Add `requireSuperAdmin()` - verifies global admin access (no tenant)
    - [ ] Add permission-based error messages with clear business context
  - [ ] Add audit logging wrapper function `logAuthorizationEvent()`
  - [ ] Update type definitions for permissions

- [ ] **Task 3: Implement Firebase Custom Claims Mapping** (AC: 1)
  - [ ] Update `src/lib/server/auth/firebase.ts`:
    - [ ] During Firebase token verification, extract custom claims
    - [ ] Map Firebase custom claims to PPDB roles
    - [ ] Store PPDB role in Session object (optional role field already exists)
    - [ ] Fallback to database user record if custom claims missing
  - [ ] Update session creation to include role from Firebase
  - [ ] Add unit tests for Firebase role mapping

- [ ] **Task 4: Implement Audit Logging for Authorization** (AC: 4)
  - [ ] Create audit logging module at `src/lib/server/auth/audit-logger.ts`:
    - [ ] Function `logAuthorizationSuccess(actorId, action, details)`
    - [ ] Function `logAuthorizationFailure(actorId, action, reason)`
    - [ ] Function `logSensitiveAction(actorId, action, target, details)`
    - [ ] Auto-include timestamp, IP address (from locals), and session context
  - [ ] Integrate audit logging into authorization helpers:
    - [ ] Log all authorization failures (403/401)
    - [ ] Log sensitive actions (role assignment, user creation, data deletion)
  - [ ] Update `src/lib/server/auth/authorization.ts` to call audit logger

- [ ] **Task 5: Update Admin Routes with Permission-Based Access** (AC: 5)
  - [ ] Update `src/routes/admin/settings/school-admins/+page.server.ts`:
    - [ ] Replace role checks with permission checks in createAdmin action
    - [ ] Replace role checks with permission checks in assignRole action
    - [ ] Replace role checks with permission checks in revokeAccess action
    - [ ] Add audit logging for all admin management actions
  - [ ] Update `src/routes/admin/settings/admission-paths/+page.server.ts`:
    - [ ] Replace `requireRole(auth, 'school_admin', 'verifier')` with `requirePermission(auth, 'admission_paths_manage')`
    - [ ] Replace `requireRole(auth, 'school_admin')` with `requirePermission(auth, 'admission_paths_archive')`
    - [ ] Add audit logging for admission path lifecycle actions (publish, close, archive)
  - [ ] Update `src/routes/admin/settings/fee-structures/+page.server.ts`:
    - [ ] Add permission checks for all fee structure actions (create, update, delete)
    - [ ] Define permission type (e.g., 'fees_manage')
    - [ ] Add audit logging for fee modifications

- [ ] **Task 6: Update Session Interface** (AC: 1)
  - [ ] Update `src/lib/server/auth/types.ts`:
    - [ ] Ensure Session interface has optional `role?: UserRole` field
    - [ ] Add permissions cache to session (optional optimization)
  - [ ] Update middleware (`src/hooks.server.ts`) to populate session role from Firebase custom claims
  - [ ] Verify session refresh preserves role information

- [ ] **Task 7: Testing - TDD Approach** (AC: 6)
  - [ ] Create unit tests in `tests/unit/authorization.test.ts`:
    - [ ] Test `requireAuth()` with valid and invalid sessions
    - [ ] Test `requireRole()` with allowed and forbidden roles
    - [ ] Test `requirePermission()` with various permission combinations
    - [ ] Test `requireAllPermissions()` edge cases
    - [ ] Test `requireSuperAdmin()` with global and tenant users
    - [ ] Test audit logging calls
  - [ ] Create integration tests in `tests/integration/rbac.test.ts`:
    - [ ] Test each role accessing protected routes
    - [ ] Test cross-tenant access attempts (should fail)
    - [ ] Test permission escalation attempts (should fail)
    - [ ] Test audit log records for authorization events
  - [ ] Test Firebase custom claims extraction and mapping

## Dev Notes

### Architecture Context

**HYBRID AUTH SYSTEM (From Story 2.5.1):**

- Firebase Auth for internal users (~231 users)
- WAHA WhatsApp OTP for external users (~10,000+ users)
- Custom database-backed sessions with role field
- Session management: `src/lib/server/auth/session.ts`
- Authorization helpers: `src/lib/server/auth/authorization.ts`

**RBAC User Roles (from schema.ts):**

```typescript
export const userRoleEnum = pgEnum('user_role', [
	'super_admin', // Platform admin, no tenant
	'school_admin', // Tenant admin
	'verifier', // Tenant verifier/interviewer
	'treasurer', // Tenant finance admin
	'parent' // WAHA-authenticated parent
]);
```

### Current Authorization Implementation Status

**Already Working:**

- ✅ `src/lib/server/auth/authorization.ts` has basic helpers:
  - `requireAuth(locals)` - validates session exists
  - `requireRole(auth, ...roles)` - checks role membership
  - `requireTenantMatch(auth, routeTenantId)` - validates tenant match
- ✅ `src/lib/server/auth/types.ts` has Session interface with optional `role?: string`
- ✅ `users` table has `role` field
- ✅ `audit_logs` table exists but unused

**Needs Enhancement:**

1. **Basic Role Checks Need Permission Mapping:**
   - `requireRole()` only checks string equality
   - No permission abstraction layer
   - No business rule documentation
   - No audit logging

2. **Firebase Role Mapping Missing:**
   - Firebase custom claims not extracted
   - Role from Firebase not synchronized with database
   - No fallback strategy when claims missing

3. **Audit Logging Not Implemented:**
   - `audit_logs` table exists but no logging function
   - No authorization event tracking
   - No sensitive action auditing

4. **Admin Routes Use Basic Role Checks:**
   - `src/routes/admin/settings/admission-paths/+page.server.ts` uses `requireRole(auth, 'school_admin', 'verifier')`
   - Should use permission-based checks instead
   - No audit logging for sensitive actions

### RBAC Permission Matrix Design

**Permission Categories to Implement:**

```typescript
// src/lib/server/auth/permissions.ts
export const PERMISSIONS = {
	// Tenant Management (Super Admin only)
	TENANT_CREATE: 'tenant:create',
	TENANT_UPDATE: 'tenant:update',
	TENANT_DELETE: 'tenant:delete',
	TENANT_READ_ALL: 'tenant:read:all',

	// Admission Paths (School Admin, Verifier)
	ADMISSION_PATHS_READ: 'admission_paths:read',
	ADMISSION_PATHS_CREATE: 'admission_paths:create',
	ADMISSION_PATHS_UPDATE: 'admission_paths:update',
	ADMISSION_PATHS_DELETE: 'admission_paths:delete',
	ADMISSION_PATHS_PUBLISH: 'admission_paths:publish',
	ADMISSION_PATHS_CLOSE: 'admission_paths:close',
	ADMISSION_PATHS_ARCHIVE: 'admission_paths:archive', // Admin only

	// Fee Structures (School Admin, Treasurer)
	FEES_READ: 'fees:read',
	FEES_CREATE: 'fees:create',
	FEES_UPDATE: 'fees:update',
	FEES_DELETE: 'fees:delete',

	// School Admin Management (School Admin only)
	ADMIN_USERS_READ: 'admin_users:read',
	ADMIN_USERS_CREATE: 'admin_users:create',
	ADMIN_USERS_ASSIGN_ROLE: 'admin_users:assign_role',
	ADMIN_USERS_REVOKE_ACCESS: 'admin_users:revoke_access',

	// Verification (Verifier, School Admin)
	APPLICATIONS_READ: 'applications:read',
	APPLICATIONS_VERIFY: 'applications:verify',
	APPLICATIONS_REJECT: 'applications:reject',

	// Scoring (Verifier, School Admin)
	SCORES_INPUT: 'scores:input',
	SCORES_UPDATE: 'scores:update',

	// Payments (Treasurer, School Admin)
	PAYMENTS_READ: 'payments:read',
	PAYMENTS_VERIFY_MANUAL: 'payments:verify_manual',
	PAYMENTS_MANAGE: 'payments:manage',

	// Reports (All roles, filtered by context)
	REPORTS_READ: 'reports:read',
	REPORTS_EXPORT: 'reports:export'
} as const;

export type Permission = (typeof PERMISSIONS)[keyof typeof PERMISSIONS];

// Role to Permission Mapping
export const ROLE_PERMISSIONS: Record<UserRole, Permission[]> = {
	super_admin: [
		// Full platform access (no tenant restriction)
		...Object.values(PERMISSIONS)
	],

	school_admin: [
		// Full tenant admin access
		PERMISSIONS.ADMISSION_PATHS_READ,
		PERMISSIONS.ADMISSION_PATHS_CREATE,
		PERMISSIONS.ADMISSION_PATHS_UPDATE,
		PERMISSIONS.ADMISSION_PATHS_DELETE,
		PERMISSIONS.ADMISSION_PATHS_PUBLISH,
		PERMISSIONS.ADMISSION_PATHS_CLOSE,
		PERMISSIONS.ADMISSION_PATHS_ARCHIVE,

		PERMISSIONS.FEES_READ,
		PERMISSIONS.FEES_CREATE,
		PERMISSIONS.FEES_UPDATE,
		PERMISSIONS.FEES_DELETE,

		PERMISSIONS.ADMIN_USERS_READ,
		PERMISSIONS.ADMIN_USERS_CREATE,
		PERMISSIONS.ADMIN_USERS_ASSIGN_ROLE,
		PERMISSIONS.ADMIN_USERS_REVOKE_ACCESS,

		PERMISSIONS.APPLICATIONS_READ,
		PERMISSIONS.APPLICATIONS_VERIFY,
		PERMISSIONS.APPLICATIONS_REJECT,

		PERMISSIONS.SCORES_INPUT,
		PERMISSIONS.SCORES_UPDATE,

		PERMISSIONS.PAYMENTS_READ,
		PERMISSIONS.PAYMENTS_VERIFY_MANUAL,
		PERMISSIONS.PAYMENTS_MANAGE,

		PERMISSIONS.REPORTS_READ,
		PERMISSIONS.REPORTS_EXPORT
	],

	verifier: [
		// Verification and scoring only
		PERMISSIONS.ADMISSION_PATHS_READ,
		PERMISSIONS.APPLICATIONS_READ,
		PERMISSIONS.APPLICATIONS_VERIFY,
		PERMISSIONS.APPLICATIONS_REJECT,
		PERMISSIONS.SCORES_INPUT,
		PERMISSIONS.SCORES_UPDATE,
		PERMISSIONS.REPORTS_READ
	],

	treasurer: [
		// Financial operations only
		PERMISSIONS.FEES_READ,
		PERMISSIONS.PAYMENTS_READ,
		PERMISSIONS.PAYMENTS_VERIFY_MANUAL,
		PERMISSIONS.PAYMENTS_MANAGE,
		PERMISSIONS.REPORTS_READ,
		PERMISSIONS.REPORTS_EXPORT
	],

	parent: [
		// Self-service access only
		PERMISSIONS.REPORTS_READ // Own applications only
	]
};
```

### Technical Requirements

**Firebase Custom Claims Mapping:**

```typescript
// src/lib/server/auth/firebase.ts (updates needed)

interface FirebaseCustomClaims {
	role: 'super_admin' | 'school_admin' | 'verifier' | 'treasurer' | 'parent';
	tenantId?: string; // Optional for super_admin
}

export async function verifyToken(token: string): Promise<FirebaseUser> {
	try {
		const decodedToken = await adminAuth.verifyIdToken(token);

		// Extract custom claims
		const customClaims = decodedToken.claims as unknown as FirebaseCustomClaims;
		const role = customClaims?.role;

		// Return user with role from Firebase
		return {
			uid: decodedToken.uid,
			email: decodedToken.email || '',
			role: role, // Pass through to session creation
			tenantId: customClaims?.tenantId
		};
	} catch (error) {
		throw new Error('Invalid Firebase token');
	}
}
```

**Enhanced Authorization Helpers:**

```typescript
// src/lib/server/auth/authorization.ts (updates needed)

export function requirePermission(auth: AuthContext, ...permissions: Permission[]): void {
	const userPermissions = getPermissionsForRole(auth.session.role as UserRole);

	const hasPermission = permissions.some((perm) => userPermissions.includes(perm));

	if (!hasPermission) {
		// Log authorization failure
		logAuthorizationFailure(
			auth.userId,
			`requirePermission: ${permissions.join(', ')}`,
			`User role ${auth.session.role} lacks required permissions`
		);
		throw svelteError(403, 'Unauthorized: Insufficient permissions');
	}
}

export function requireAllPermissions(auth: AuthContext, ...permissions: Permission[]): void {
	const userPermissions = getPermissionsForRole(auth.session.role as UserRole);

	const hasAllPermissions = permissions.every((perm) => userPermissions.includes(perm));

	if (!hasAllPermissions) {
		logAuthorizationFailure(
			auth.userId,
			`requireAllPermissions: ${permissions.join(', ')}`,
			`User role ${auth.session.role} lacks all required permissions`
		);
		throw svelteError(403, 'Unauthorized: Insufficient permissions');
	}
}

export function requireSuperAdmin(auth: AuthContext): void {
	if (auth.session.role !== 'super_admin') {
		logAuthorizationFailure(
			auth.userId,
			'requireSuperAdmin',
			`User role ${auth.session.role} is not super_admin`
		);
		throw svelteError(403, 'Unauthorized: Super Admin access required');
	}
}
```

**Audit Logging Implementation:**

```typescript
// src/lib/server/auth/audit-logger.ts (NEW FILE)

import { db } from '$lib/server/db';
import { auditLogs } from '$lib/server/db/schema';
import type { UserRole } from '$lib/server/db/schema';

export interface AuditLogDetails {
	target?: string;
	[key: string]: any;
}

export async function logAuthorizationSuccess(
	actorId: string,
	action: string,
	details?: AuditLogDetails
): Promise<void> {
	await db.insert(auditLogs).values({
		actorId,
		action: `auth_success:${action}`,
		target: details?.target,
		details: JSON.stringify(details)
	});
}

export async function logAuthorizationFailure(
	actorId: string,
	action: string,
	reason: string
): Promise<void> {
	await db.insert(auditLogs).values({
		actorId,
		action: `auth_failure:${action}`,
		details: JSON.stringify({ reason })
	});
}

export async function logSensitiveAction(
	actorId: string,
	action: string,
	target: string,
	details: AuditLogDetails
): Promise<void> {
	await db.insert(auditLogs).values({
		actorId,
		action: `sensitive:${action}`,
		target,
		details: JSON.stringify(details)
	});
}
```

### Usage Pattern in Server Actions

**Before (Story 2.5.2):**

```typescript
// Current pattern - basic role check
export const publish: Action = async ({ request, locals }) => {
	const auth = requireAuth(locals);
	requireRole(auth, 'school_admin', 'verifier'); // Hardcoded roles

	// ... action logic
};
```

**After (Story 2.5.3):**

```typescript
// New pattern - permission-based check
export const publish: Action = async ({ request, locals }) => {
	const auth = requireAuth(locals);
	requirePermission(auth, PERMISSIONS.ADMISSION_PATHS_PUBLISH);

	// Log sensitive action
	await logSensitiveAction(auth.userId, 'publish_admission_path', pathId, { pathName: path.name });

	// ... action logic
};

// Archive action - admin only
export const archive: Action = async ({ request, locals }) => {
	const auth = requireAuth(locals);
	requirePermission(auth, PERMISSIONS.ADMISSION_PATHS_ARCHIVE); // Only school_admin has this

	await logSensitiveAction(auth.userId, 'archive_admission_path', pathId, {});

	// ... action logic
};
```

### Tenant Isolation Enforcement

**Critical Rule:** All authorization checks must work in conjunction with tenant isolation from Story 1.2 and 1.3.

**Authorization + Tenant Isolation Pattern:**

```typescript
// Correct pattern - verify auth, then tenant, then permissions
export const updateProfile: Action = async ({ request, locals }) => {
	// 1. Verify authentication and tenant
	const { userId, tenantId } = requireAuth(locals);

	// 2. Verify specific permission
	requirePermission(auth, PERMISSIONS.TENANT_UPDATE);

	// 3. All database queries use tenantId
	const updated = await updateSchoolProfile(db, tenantId, data);

	// 4. Log sensitive action
	await logSensitiveAction(userId, 'update_school_profile', tenantId, {
		changes: data
	});

	return { success: true };
};
```

### Testing Standards Summary

**TDD Approach Required:**

1. Write tests FIRST, then implement
2. Each task should have corresponding test coverage

**Test Types:**

- **Unit Tests** (`tests/unit/authorization.test.ts`):
  - `requireAuth()` with valid/invalid session
  - `requireRole()` with various role combinations
  - `requirePermission()` with different permissions
  - `requireAllPermissions()` edge cases
  - `requireSuperAdmin()` with non-admin users
  - `hasPermission()` for each role
  - `getPermissionsForRole()` returns correct lists
  - Audit logging functions create database records

- **Integration Tests** (`tests/integration/rbac.test.ts`):
  - Super Admin accessing all tenant data (should succeed)
  - School Admin managing their own tenant (should succeed)
  - School Admin accessing other tenant (should fail - 403)
  - Verifier accessing admission paths (should succeed)
  - Verifier archiving paths (should fail - 403)
  - Treasurer managing fees (should succeed)
  - Treasurer managing admission paths (should fail - 403)
  - Cross-tenant access attempts (should all fail)
  - Audit logs created for authorization failures
  - Audit logs created for sensitive actions

- **E2E Tests** (`e2e/rbac-e2e.test.ts` or update existing):
  - Complete admin workflows with different roles
  - Verify UI elements hidden for unauthorized roles
  - Test permission error messages are user-friendly

**Test Coverage Goals:**

- Authorization helpers: 95%+ coverage
- Permission matrix: 100% coverage
- Audit logging: 90%+ coverage
- RBAC integration tests: Cover all role-permission combinations

### Anti-Patterns to Avoid

❌ **DO NOT** hardcode role checks directly in server actions (use permissions)
❌ **DO NOT** skip audit logging for sensitive actions
❌ **DO NOT** use string literals for roles/permissions (use constants from permissions.ts)
❌ **DO NOT** bypass authorization for convenience
❌ **DO NOT** mix tenant isolation with authorization (separate concerns)
❌ **DO NOT** forget to extract Firebase custom claims
❌ **DO NOT** assume database role is always correct (validate with Firebase)
❌ **DO NOT** expose detailed system errors to users on authorization failures

### Integration Points

**Existing Systems:**

- **Firebase Auth (Story 2.5.1):** Custom claims extraction and role mapping
- **Session Management (Story 2.5.1):** Session object with role field
- **Tenant Resolution (Story 1.3):** Authorization must work with tenant context
- **Tenant Isolation (Story 1.2):** Authorization checks complement RLS policies
- **Authorization Helpers (Story 2.5.2):** Extend existing helpers with permissions
- **Audit Logs Table (Epic 1):** Write authorization event records

**Files to Create:**

```
src/lib/server/auth/permissions.ts       # Permission constants and role mapping
src/lib/server/auth/audit-logger.ts     # Audit logging functions
tests/unit/rbac.test.ts                # RBAC unit tests
tests/integration/rbac.test.ts          # RBAC integration tests
```

**Files to Modify:**

```
src/lib/server/auth/authorization.ts     # Enhanced with permission checks
src/lib/server/auth/firebase.ts         # Add custom claims extraction
src/lib/server/auth/types.ts            # Ensure Session interface has role
src/hooks.server.ts                     # Populate session role from Firebase
src/routes/admin/settings/school-admins/+page.server.ts
src/routes/admin/settings/admission-paths/+page.server.ts
src/routes/admin/settings/fee-structures/+page.server.ts
```

### Success Metrics

- Firebase custom claims mapped to PPDB roles correctly
- Comprehensive RBAC permission matrix documented and implemented
- Permission checking helpers working for all permission types
- All authorization failures logged to audit_logs
- All sensitive actions (create, update, delete, role assignment) logged
- Admin routes using permission-based access control instead of hardcoded roles
- Integration tests passing for all role-permission combinations
- Cross-tenant access attempts properly blocked with 403 errors
- Audit log records contain all required fields (actorId, action, details)

### Dependencies

**Prerequisites:**

- Story 2.5.1 MUST be completed (Firebase + WAHA hybrid auth)
- Story 2.5.2 MUST be completed (session-based authorization in routes)

**Blocked By:**

- None (Story 2.5.1 is in 'review', 2.5.2 is 'ready-for-dev')

**Next Stories:**

- Story 2.5.4: Test Auth Flow End-to-End
- Story 2.5.5: Document Auth Integration for Epic 3

## References

- **Story 2.5.1:** Firebase + WAHA Hybrid Authentication Integration [Source: /_bmad-output/implementation-artifacts/2.5.1-firebase-waha-hybrid-authentication-integration.md]
- **Story 2.5.2:** Replace Session Placeholder with Hybrid Auth Session [Source: /_bmad-output/implementation-artifacts/2.5.2-replace-session-placeholder-with-hybrid-auth-session.md]
- **Story 1.3:** Subdomain Resolution & Routing - Authorization must work with tenant context [Source: /_bmad-output/implementation-artifacts/1-3-subdomain-resolution-routing.md]
- **Story 1.2:** Tenant Database Isolation (RLS) - Authorization checks complement RLS [Source: /_bmad-output/implementation-artifacts/1-2-tenant-database-isolation-rls.md]
- **Architecture:** Authentication & Security with Custom Auth Logic [Source: /_bmad-output/planning-artifacts/architecture.md#Authentication & Security]
- **PRD:** FR12 (RBAC for all user types), FR30 (Global role management) [Source: /_bmad-output/planning-artifacts/prd.md]
- **Sprint Status:** Epic 2.5 stories and progress tracking [Source: /_bmad-output/sprint-status.yaml]

## Dev Agent Record

### Agent Model Used

Claude (Anthropic)

### Completion Notes List

- **Story Context:** This story builds on Stories 2.5.1 and 2.5.2 to implement comprehensive RBAC permission system with Firebase role mapping and audit logging.
- **RBAC Matrix Design:** Created comprehensive permission matrix with 5 roles (super_admin, school_admin, verifier, treasurer, parent) and 20+ permission categories.
- **Firebase Integration:** Need to extract Firebase custom claims and map to PPDB roles in `firebase.ts` during token verification.
- **Audit Logging:** Implement audit logging for all authorization failures and sensitive actions using existing `audit_logs` table.
- **Permission-Based Authorization:** Replace hardcoded role checks in admin routes with permission-based checks for better maintainability.
- **Security Priority:** All authorization checks must complement existing tenant isolation (RLS) from Story 1.2, not bypass it.

**Implementation Strategy:**

1. Define comprehensive permission matrix in `permissions.ts` with role-permission mappings
2. Enhance authorization helpers with `requirePermission()` and `requireAllPermissions()`
3. Implement Firebase custom claims extraction during token verification
4. Create audit logging module for authorization events and sensitive actions
5. Update all admin routes to use permission-based checks instead of hardcoded roles
6. Comprehensive testing (unit, integration, E2E) for all RBAC scenarios

**Key Files to Create:**

- `src/lib/server/auth/permissions.ts` - Permission constants and role-permission matrix
- `src/lib/server/auth/audit-logger.ts` - Audit logging functions for authorization events

**Key Files to Modify:**

- `src/lib/server/auth/authorization.ts` - Add permission checking helpers
- `src/lib/server/auth/firebase.ts` - Extract Firebase custom claims
- `src/routes/admin/settings/school-admins/+page.server.ts` - Use permission checks
- `src/routes/admin/settings/admission-paths/+page.server.ts` - Use permission checks
- `src/routes/admin/settings/fee-structures/+page.server.ts` - Use permission checks

### File List

**New Files:**

- src/lib/server/auth/permissions.ts
- src/lib/server/auth/audit-logger.ts
- tests/unit/rbac.test.ts
- tests/integration/rbac.test.ts

**Modified Files:**

- src/lib/server/auth/authorization.ts
- src/lib/server/auth/firebase.ts
- src/hooks.server.ts
- src/routes/admin/settings/school-admins/+page.server.ts
- src/routes/admin/settings/admission-paths/+page.server.ts
- src/routes/admin/settings/fee-structures/+page.server.ts

**No Database Changes Required:**

- `users` table already has `role` field
- `audit_logs` table already exists
- `sessions` table already has optional `role` field
- No new migrations needed

**Environment Variables Required:**

- None new - all auth environment variables from Story 2.5.1 (FIREBASE_PROJECT_ID, FIREBASE_PRIVATE_KEY, FIREBASE_CLIENT_EMAIL, WAHA_BASE_URL, WAHA_SESSION)
