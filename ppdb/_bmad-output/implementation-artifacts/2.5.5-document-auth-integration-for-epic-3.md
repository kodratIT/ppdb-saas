# Story 2.5.5: Document Auth Integration for Epic 3

Status: ready-for-dev

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a Technical Writer,
I want to document the Firebase + WAHA hybrid authentication system with comprehensive integration guides for Epic 3 developers,
so that Epic 3 (Frictionless Registration) teams can understand and integrate with the auth system without confusion or implementation errors.

## Acceptance Criteria

1. **Complete auth system documentation** - Document all components of the Firebase + WAHA hybrid authentication system, including architecture, data flow, and integration points
2. **Firebase integration guide with examples** - Provide step-by-step guide for Firebase authentication with code examples for sign-in, sign-up, token verification, and role mapping
3. **WAHA OTP integration guide with examples** - Provide detailed guide for WhatsApp OTP authentication including API endpoints, request/response formats, and usage patterns
4. **RBAC permission matrix documented with usage** - Complete documentation of all 5 roles (super_admin, school_admin, verifier, treasurer, parent), their permissions, and authorization patterns
5. **Session management documentation** - Document session creation, validation, refresh, expiration, and security patterns for both Firebase and WAHA users
6. **Testing setup and environment configuration guide** - Document all environment variables, test database setup, mock services, and test execution procedures

## Tasks / Subtasks

- [ ] **Task 1: Document Auth System Architecture** (AC: 1)
  - [ ] Create architecture overview diagram showing Firebase + WAHA hybrid flow
  - [ ] Document system components and their responsibilities:
    - Firebase Auth (internal users)
    - WAHA Provider (external users)
    - Session Management (database-backed)
    - Authorization Helpers (RBAC)
    - Audit Logging
  - [ ] Document data flow for both auth types
  - [ ] Document tenant integration with subdomain resolution (Story 1.3)
  - [ ] Document session structure and lifecycle

- [ ] **Task 2: Create Firebase Integration Guide** (AC: 2)
  - [ ] Document Firebase setup and configuration
  - [ ] Document environment variables required (FIREBASE_PROJECT_ID, FIREBASE_PRIVATE_KEY, FIREBASE_CLIENT_EMAIL)
  - [ ] Document Firebase Admin SDK installation
  - [ ] Document Firebase token verification flow with code examples
  - [ ] Document Firebase custom claims mapping to PPDB roles
  - [ ] Document sign-in flow with code examples (`src/routes/sign-in/+page.server.ts`, `src/routes/sign-in/+page.svelte`)
  - [ ] Document sign-up flow with code examples (`src/routes/sign-up/+page.server.ts`, `src/routes/sign-up/+page.svelte`)
  - [ ] Document common error handling patterns
  - [ ] Document testing Firebase auth in development

- [ ] **Task 3: Create WAHA OTP Integration Guide** (AC: 3)
  - [ ] Document WAHA system context (existing self-hosted system)
  - [ ] Document environment variables required (WAHA_BASE_URL, WAHA_SESSION)
  - [ ] Document WAHA provider interface and implementation (`src/lib/server/whatsapp/providers/waha.ts`)
  - [ ] Document OTP request flow:
    - API endpoint: POST /api/sendText to WAHA server
    - Request format and parameters
    - OTP generation (6-digit code)
    - OTP expiration (5 minutes)
  - [ ] Document OTP verification flow with code examples
  - [ ] Document session creation for WAHA users
  - [ ] Document error handling for invalid/expired OTP
  - [ ] Document retry limits and account lockout
  - [ ] Document integration with tenant context (inherit from application URL)

- [ ] **Task 4: Document RBAC Permission Matrix** (AC: 4)
  - [ ] Document all 5 user roles and their responsibilities:
    - super_admin: Platform admin, no tenant restriction
    - school_admin: Tenant admin, full tenant access
    - verifier: Verification and scoring access
    - treasurer: Financial operations access
    - parent: Self-service access (own applications)
  - [ ] Document all permission categories and their definitions:
    - Tenant Management (super_admin only)
    - Admission Paths (school_admin, verifier)
    - Fee Structures (school_admin, treasurer)
    - School Admin Management (school_admin only)
    - Verification (verifier, school_admin)
    - Scoring (verifier, school_admin)
    - Payments (treasurer, school_admin)
    - Reports (all roles, filtered by context)
  - [ ] Document role-to-permission mapping matrix
  - [ ] Document permission checking helpers (`requireAuth`, `requireRole`, `requirePermission`, `requireAllPermissions`, `requireSuperAdmin`)
  - [ ] Provide code examples for each authorization pattern
  - [ ] Document usage in server actions and load functions
  - [ ] Document Firebase custom claims extraction and role mapping

- [ ] **Task 5: Document Session Management** (AC: 5)
  - [ ] Document session structure and schema (`src/lib/server/db/schema.ts` - sessions table)
  - [ ] Document session creation flow for Firebase users
  - [ ] Document session creation flow for WAHA users
  - [ ] Document session validation in middleware (`src/hooks.server.ts`)
  - [ ] Document session refresh mechanism and timing
  - [ ] Document session expiration handling
  - [ ] Document session cookie management (session_id)
  - [ ] Document concurrent session handling
  - [ ] Document security best practices:
    - Session binding to tenant
    - Session invalidation on sign-out
    - Session tampering prevention
    - HTTPS-only cookie configuration

- [ ] **Task 6: Document Audit Logging** (AC: 1)
  - [ ] Document audit logging functions (`src/lib/server/auth/audit-logger.ts`)
  - [ ] Document authorization failure logging
  - [ ] Document sensitive action logging (user creation, role assignment, data deletion)
  - [ ] Document audit log structure and fields (actorId, action, target, details)
  - [ ] Document integration with authorization helpers
  - [ ] Provide code examples for audit logging in routes

- [ ] **Task 7: Create Testing Setup Guide** (AC: 6)
  - [ ] Document all environment variables for testing:
    - Firebase test credentials
    - WAHA test credentials
    - Test database (DATABASE_URL)
    - Test mode (NODE_ENV=test)
  - [ ] Document test database setup
  - [ ] Document mock Firebase Auth service configuration
  - [ ] Document mock WAHA provider configuration
  - [ ] Document test fixtures for all user roles (`tests/e2e/fixtures.ts`)
  - [ ] Document test helpers (`tests/e2e/helpers.ts`)
  - [ ] Document test execution:
    - Unit tests: `npm run test:unit`
    - Integration tests: `npm run test:integration`
    - E2E tests: `npm run test:e2e`
  - [ ] Document Playwright configuration (`playwright.config.ts`)
  - [ ] Document test coverage goals and reporting

- [ ] **Task 8: Document Integration Points for Epic 3** (AC: 1)
  - [ ] Document how Epic 3 (Registration) should integrate with auth:
    - Parent registration via WAHA OTP
    - Session validation for multi-step forms
    - Role-based UI component visibility
    - Permission checking for draft operations
  - [ ] Document parent role permissions and restrictions
  - [ ] Document tenant context inheritance for registration
  - [ ] Document session persistence during multi-step registration
  - [ ] Provide Epic 3-specific code examples
  - [ ] Document common pitfalls and anti-patterns to avoid

- [ ] **Task 9: Create Troubleshooting Guide** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Document common Firebase auth issues and solutions
  - [ ] Document common WAHA OTP issues and solutions
  - [ ] Document common session management issues and solutions
  - [ ] Document common RBAC/authorization issues and solutions
  - [ ] Document common testing issues and solutions
  - [ ] Provide debug tips and tools
  - [ ] Document where to find logs and how to interpret them

- [ ] **Task 10: Review and Validate Documentation** (AC: All)
  - [ ] Review all sections for completeness and accuracy
  - [ ] Validate code examples against actual implementation
  - [ ] Verify environment variables are correct
  - [ ] Ensure all integration points are documented
  - [ ] Test documentation by following it in fresh environment
  - [ ] Gather feedback from Epic 3 developers
  - [ ] Create documentation index and navigation structure

## Dev Notes

### Architecture Context

**HYBRID AUTHENTICATION SYSTEM (From Stories 2.5.1-2.5.4):**

This documentation task captures the complete Firebase + WAHA hybrid authentication system implemented in Epic 2.5. The system serves two distinct user groups:

- **Internal Users (~231):** Firebase Auth (email/password)
  - Roles: Super Admin, Admin Yayasan, Admin Sekolah, Staff, Penguji, Treasurer
  - Firebase SDK: Free tier ($0), ~3,133 MAU
- **External Users (~10,000+):** WAHA WhatsApp OTP
  - WAHA is an EXISTING self-hosted system - INTEGRATION ONLY (no setup/docs for WAHA)
  - POST /api/sendText to existing WAHA server
  - Cost: $0 (existing infrastructure)

**Core Components Already Implemented:**

1. **Firebase Authentication** (`src/lib/server/auth/firebase.ts`)
   - Firebase Admin SDK integration
   - Token verification
   - User creation and authentication
   - Custom claims extraction for role mapping

2. **WAHA OTP Provider** (`src/lib/server/whatsapp/providers/waha.ts`)
   - POST /api/sendText integration
   - OTP generation (6-digit)
   - OTP verification
   - Error handling

3. **Session Management** (`src/lib/server/auth/session.ts`)
   - Database-backed sessions (sessions table)
   - Session creation for both Firebase and WAHA users
   - Session validation
   - Session refresh and expiration
   - Cookie management (session_id)

4. **Authorization Helpers** (`src/lib/server/auth/authorization.ts`)
   - `requireAuth()` - session validation
   - `requireRole()` - role checking
   - `requirePermission()` - permission-based authorization
   - `requireAllPermissions()` - all required permissions
   - `requireSuperAdmin()` - global admin access
   - `requireTenantMatch()` - tenant validation

5. **RBAC Permissions** (`src/lib/server/auth/permissions.ts`)
   - Permission constants for all system actions
   - Role-to-permission mapping (5 roles, 20+ permissions)
   - Permission checking helper functions

6. **Audit Logging** (`src/lib/server/auth/audit-logger.ts`)
   - Authorization failure logging
   - Sensitive action logging
   - Audit log database operations

7. **Middleware Integration** (`src/hooks.server.ts`)
   - Session validation
   - Tenant context preservation
   - Cookie management
   - Error handling

### Current Implementation Status

**Stories 2.5.1-2.5.4 are COMPLETE (review status):**

- ✅ **Story 2.5.1:** Firebase + WAHA Hybrid Authentication Integration
- ✅ **Story 2.5.2:** Replace Session Placeholder with Hybrid Auth Session
- ✅ **Story 2.5.3:** Update All Permission Checking Helpers
- ✅ **Story 2.5.4:** Test Auth Flow End-to-End (112 E2E tests created)

**All Implementation Files Exist:**

```
src/lib/server/auth/
├── firebase.ts              # Firebase Admin SDK wrapper
├── session.ts              # Session management
├── types.ts                # Auth-related types
├── authorization.ts        # Authorization helpers
├── permissions.ts          # RBAC permission matrix
└── audit-logger.ts        # Audit logging functions

src/lib/server/whatsapp/
└── providers/
    ├── types.ts            # Provider interface
    └── waha.ts           # WAHA provider implementation

src/routes/sign-in/         # Firebase sign-in
src/routes/sign-up/         # Firebase sign-up
src/routes/admin/           # Protected admin routes

tests/unit/                # Unit tests
├── firebase-auth.test.ts
├── session.test.ts
├── authorization.test.ts
├── rbac.test.ts
└── audit-logger.test.ts

tests/integration/         # Integration tests
└── waha-otp.test.ts

e2e/                      # E2E tests
├── fixtures.ts           # Test fixtures
├── helpers.ts            # Test helpers
├── firebase-auth.test.ts
├── waha-otp.test.ts
├── session-management.test.ts
├── rbac-permissions.test.ts
├── tenant-isolation.test.ts
└── audit-logging.test.ts
```

### Technical Requirements

**Documentation Structure:**

```
docs/auth/
├── README.md                    # Auth system overview and quick start
├── architecture.md              # Architecture overview and data flow
├── firebase-integration.md     # Firebase setup and usage guide
├── waha-otp-integration.md    # WAHA OTP setup and usage guide
├── rbac-permissions.md        # RBAC permission matrix and usage
├── session-management.md       # Session management documentation
├── audit-logging.md           # Audit logging documentation
├── testing-guide.md           # Testing setup and execution
├── epic-3-integration.md      # Epic 3 integration guide
└── troubleshooting.md         # Common issues and solutions
```

**Documentation Content Requirements:**

1. **Architecture Overview:**
   - High-level diagram showing Firebase and WAHA flows
   - Component responsibilities
   - Data flow sequences
   - Tenant integration with subdomain resolution

2. **Firebase Integration Guide:**
   - Prerequisites and setup
   - Environment variables
   - Code examples for:
     - Token verification
     - Custom claims extraction
     - Sign-in flow
     - Sign-up flow
   - Error handling patterns
   - Testing in development

3. **WAHA OTP Integration Guide:**
   - WAHA system context (existing self-hosted)
   - Environment variables
   - API endpoint documentation (POST /api/sendText)
   - Code examples for:
     - OTP request
     - OTP verification
     - Session creation
   - Error handling
   - Retry limits and lockout

4. **RBAC Permission Matrix:**
   - Role definitions (5 roles)
   - Permission categories (8 categories)
   - Role-to-permission mapping table
   - Authorization helper usage examples
   - Code patterns for server actions and load functions

5. **Session Management:**
   - Session structure and schema
   - Creation flows (Firebase vs WAHA)
   - Validation in middleware
   - Refresh mechanism
   - Expiration handling
   - Security best practices

6. **Audit Logging:**
   - Logging function documentation
   - Authorization failure logging
   - Sensitive action logging
   - Integration patterns
   - Code examples

7. **Testing Guide:**
   - Environment setup
   - Test database configuration
   - Mock services (Firebase, WAHA)
   - Test fixtures and helpers
   - Test execution commands
   - Coverage goals

8. **Epic 3 Integration:**
   - Parent registration via WAHA OTP
   - Session validation for multi-step forms
   - Role-based UI visibility
   - Permission checking for drafts
   - Tenant context inheritance
   - Code examples for Epic 3

9. **Troubleshooting:**
   - Common Firebase auth issues
   - Common WAHA OTP issues
   - Common session issues
   - Common RBAC/authorization issues
   - Debug tips and tools

### Project Structure Notes

**Unified Project Structure Alignment:**

All auth-related code follows the unified project structure:

- `src/lib/server/auth/` - Server-side auth logic
- `src/lib/server/whatsapp/` - WhatsApp provider integration
- `src/routes/sign-in/` - Firebase sign-in pages
- `src/routes/sign-up/` - Firebase sign-up pages
- `tests/unit/` - Unit tests
- `tests/integration/` - Integration tests
- `e2e/` - End-to-end tests

**No Conflicts or Variances:**

The implementation follows the unified project structure exactly as planned. Documentation should reference these exact paths.

### References

- **Story 2.5.1:** Firebase + WAHA Hybrid Authentication Integration [Source: /_bmad-output/implementation-artifacts/2.5.1-firebase-waha-hybrid-authentication-integration.md]
- **Story 2.5.2:** Replace Session Placeholder with Hybrid Auth Session [Source: /_bmad-output/implementation-artifacts/2.5.2-replace-session-placeholder-with-hybrid-auth-session.md]
- **Story 2.5.3:** Update All Permission Checking Helpers [Source: /_bmad-output/implementation-artifacts/2.5.3-update-all-permission-checking-helpers.md]
- **Story 2.5.4:** Test Auth Flow End-to-End [Source: /_bmad-output/implementation-artifacts/2.5.4-test-auth-flow-end-to-end.md]
- **Sprint Status:** Epic 2.5 stories and progress tracking [Source: /_bmad-output/sprint-status.yaml]
- **Epic 2 Retrospective:** Auth foundation completion and Epic 3 dependency [Source: /_bmad-output/retrospectives/epic-2-retrospective-2026-01-09.md]
- **Architecture:** Authentication & Security with Custom Auth Logic [Source: /_bmad-output/planning-artifacts/architecture.md#Authentication & Security]
- **PRD:** FR10 (WhatsApp/Email OTP), FR11 (Account Recovery), FR12 (RBAC) [Source: /_bmad-output/planning-artifacts/prd.md]

## Dev Agent Record

### Agent Model Used

Claude (Anthropic)

### Completion Notes List

- **Story Context:** This is the final story in Epic 2.5 (Auth Foundation). Epic 2.5 is 80% complete (4/5 stories done). Epic 3 (Registration) is BLOCKED until Epic 2.5 is complete. This documentation will unblock Epic 3 by providing comprehensive integration guides.

- **Purpose:** Create comprehensive documentation for the Firebase + WAHA hybrid authentication system so that Epic 3 developers can understand and integrate with the auth system without confusion or implementation errors.

- **Key Artifacts to Document:**
  1. Firebase authentication implementation (firebase.ts, sign-in, sign-up pages)
  2. WAHA OTP provider integration (waha.ts)
  3. Session management system (session.ts, sessions table, middleware)
  4. RBAC permission matrix (permissions.ts, authorization.ts)
  5. Audit logging system (audit-logger.ts)
  6. Testing infrastructure (test files, fixtures, helpers)

- **Documentation Requirements:**
  - Complete auth system architecture overview
  - Firebase integration guide with code examples
  - WAHA OTP integration guide with code examples
  - RBAC permission matrix with usage patterns
  - Session management documentation
  - Audit logging documentation
  - Testing setup and environment configuration guide
  - Epic 3 integration guide with specific examples
  - Troubleshooting guide for common issues

- **Target Audience:**
  - Epic 3 developers implementing Frictionless Registration
  - Developers integrating with auth system for user-facing features
  - QA engineers testing auth flows
  - Platform maintainers troubleshooting issues

- **Epic 3 Integration Points:**
  - Parent registration via WAHA OTP (primary auth flow)
  - Session validation for multi-step form wizard
  - Role-based UI component visibility (parent role)
  - Permission checking for draft operations
  - Tenant context inheritance from registration URL

- **Success Metrics:**
  - Epic 3 developers can integrate auth system without questions
  - All code examples are accurate and tested
  - Documentation covers all common use cases
  - Troubleshooting guide resolves known issues
  - Epic 3 can start development immediately

### File List

**New Files (Documentation to Create):**

- docs/auth/README.md
- docs/auth/architecture.md
- docs/auth/firebase-integration.md
- docs/auth/waha-otp-integration.md
- docs/auth/rbac-permissions.md
- docs/auth/session-management.md
- docs/auth/audit-logging.md
- docs/auth/testing-guide.md
- docs/auth/epic-3-integration.md
- docs/auth/troubleshooting.md

**Existing Files (Already Implemented - Reference Only):**

- src/lib/server/auth/firebase.ts (Firebase Admin SDK wrapper)
- src/lib/server/auth/session.ts (Session management)
- src/lib/server/auth/types.ts (Auth types)
- src/lib/server/auth/authorization.ts (Authorization helpers)
- src/lib/server/auth/permissions.ts (RBAC permission matrix)
- src/lib/server/auth/audit-logger.ts (Audit logging)
- src/lib/server/whatsapp/providers/types.ts (Provider interface)
- src/lib/server/whatsapp/providers/waha.ts (WAHA provider)
- src/routes/sign-in/+page.server.ts (Sign-in server logic)
- src/routes/sign-in/+page.svelte (Sign-in UI)
- src/routes/sign-up/+page.server.ts (Sign-up server logic)
- src/routes/sign-up/+page.svelte (Sign-up UI)
- src/hooks.server.ts (Middleware integration)
- tests/unit/firebase-auth.test.ts
- tests/unit/session.test.ts
- tests/unit/authorization.test.ts
- tests/unit/rbac.test.ts
- tests/unit/audit-logger.test.ts
- tests/integration/waha-otp.test.ts
- e2e/fixtures.ts
- e2e/helpers.ts
- e2e/firebase-auth.test.ts
- e2e/waha-otp.test.ts
- e2e/session-management.test.ts
- e2e/rbac-permissions.test.ts
- e2e/tenant-isolation.test.ts
- e2e/audit-logging.test.ts

**No Implementation Code Changes Required:**

This story is documentation-only. No code files need to be modified. All implementation is complete from Stories 2.5.1-2.5.4.

**Environment Variables to Document:**

```env
# Firebase (internal users)
FIREBASE_PROJECT_ID=ppdb-saas
FIREBASE_PRIVATE_KEY=...
FIREBASE_CLIENT_EMAIL=...

# WAHA (external users, existing system)
WAHA_BASE_URL=http://existing-waha-server.com
WAHA_SESSION=default

# Database
DATABASE_URL=postgresql://user:pass@host:5432/ppdb

# Testing
NODE_ENV=test
```
