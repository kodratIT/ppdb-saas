# Story 2.5.2: Replace Session Placeholder with Hybrid Auth Session (Firebase + WAHA)

Status: completed

## Story

As a Developer,
I want to replace all TODO auth placeholders and mock tenant IDs with actual Firebase + WAHA session-based authorization,
so that all admin routes are properly secured with session validation and role-based access control.

## Acceptance Criteria

1. **All mock tenant IDs replaced** - Replace `MOCK_TENANT_ID` and 'placeholder-tenant-id' with `locals.tenantId` from session
2. **Session validation in all admin routes** - All server actions verify `locals.session` exists before processing
3. **Role-based authorization implemented** - Add role checks for sensitive operations (create, update, delete)
4. **Tenant isolation verified** - All queries use `locals.tenantId` for tenant-scoped data access
5. **Session refresh logic** - Implement session refresh on active routes to prevent premature expiration
6. **Error handling for expired sessions** - Proper 401 redirects when session is invalid or expired

## Tasks / Subtasks

- [ ] **Task 1: Audit and Catalog All Auth Placeholders** (AC: 1)
  - [ ] Scan all admin routes for MOCK_TENANT_ID usage
  - [ ] Scan all admin routes for placeholder auth comments
  - [ ] Document routes requiring role-based authorization
  - [ ] Identify routes needing session refresh logic

- [ ] **Task 2: Replace Auth Placeholders in Settings Pages** (AC: 1, 2, 3)
  - [ ] Update `src/routes/admin/settings/school-admins/+page.server.ts`:
    - [ ] Replace 'placeholder-tenant-id' with `locals.tenantId` (line 11)
    - [ ] Replace 'placeholder-tenant-id' in createAdmin action (line 33)
    - [ ] Replace 'placeholder-tenant-id' in assignRole action (line 60)
    - [ ] Replace 'placeholder-tenant-id' in revokeAccess action (line 82)
    - [ ] Add session validation check in load function
    - [ ] Add role-based authorization for create/assign/revoke operations
  - [ ] Update `src/routes/admin/settings/+page.server.ts`:
    - [ ] Verify session validation is working (lines 11, 37)
    - [ ] Ensure tenantId is from locals.session

- [ ] **Task 3: Replace Mock Tenant IDs in Admission Paths** (AC: 1, 2, 4)
  - [ ] Update `src/routes/admin/settings/admission-paths/+page.server.ts`:
    - [ ] Replace MOCK_TENANT_ID in load function (line 9)
    - [ ] Replace MOCK_TENANT_ID in all actions (create, update, delete, publish, close, reopen, archive)
    - [ ] Add session validation to all actions
    - [ ] Add role checks for admin-only operations (publish, close, archive)
  - [ ] Verify tenant isolation in all queries

- [ ] **Task 4: Replace Mock Tenant IDs in Fee Structures** (AC: 1, 2, 4)
  - [ ] Update `src/routes/admin/settings/fee-structures/+page.server.ts`:
    - [ ] Replace MOCK_TENANT_ID in load function (line 11)
    - [ ] Replace MOCK_TENANT_ID in all actions (createFee, updateFee, deleteFee)
    - [ ] Add session validation to all actions
    - [ ] Add role checks for create/update/delete operations
  - [ ] Verify tenant isolation in all queries

- [ ] **Task 5: Implement Role-Based Authorization Helper** (AC: 3)
  - [ ] Create `src/lib/server/auth/authorization.ts` with:
    - [ ] `requireAuth()` - checks for valid session
    - [ ] `requireRole(...roles)` - checks session user has specific role
    - [ ] `requireTenantMatch()` - validates session.tenantId matches route tenant
  - [ ] Integrate authorization helper into admin routes
  - [ ] Add unit tests for authorization helper

- [ ] **Task 6: Implement Session Refresh Logic** (AC: 5)
  - [ ] Identify active routes that should refresh sessions (e.g., dashboard, settings)
  - [ ] Add session refresh call to middleware or route handlers
  - [ ] Ensure refresh extends session expiration time
  - [ ] Handle refresh failures gracefully

- [ ] **Task 7: Error Handling for Invalid Sessions** (AC: 6)
  - [ ] Add consistent 401 redirect to `/sign-in` for invalid sessions
  - [ ] Add error messages for expired sessions
  - [ ] Clear invalid session cookies on 401 responses
  - [ ] Test expired session handling

- [ ] **Task 8: Testing - TDD Approach** (AC: All)
  - [ ] Create unit tests for authorization helper in `tests/unit/authorization.test.ts`
  - [ ] Create integration tests for session-protected routes
  - [ ] Test tenant isolation in all modified routes
  - [ ] Test role-based access control (admin, verifier, treasurer roles)
  - [ ] Test session refresh logic
  - [ ] Test expired session error handling

## Dev Notes

### Architecture Context

**HYBRID AUTH SYSTEM (From Story 2.5.1):**

- Firebase Auth for internal users (~231 users)
- WAHA WhatsApp OTP for external users (~10,000+ users)
- Custom database-backed sessions (NOT Firebase sessions only)
- Session management: `src/lib/server/auth/session.ts`
- Middleware integration: `src/hooks.server.ts`

**Session Structure (from session.ts):**

```typescript
interface Session {
	id: string;
	userId: string;
	tenantId: string; // CRITICAL: Must be preserved
	authType: 'firebase' | 'waha';
	authIdentifier: string; // Firebase UID or phone number
	expiresAt: Date;
	createdAt: Date;
}
```

**Locals Interface (from app.d.ts):**

```typescript
interface Locals {
  tenantId?: string;        // Set by subdomain resolution
  tenant?: {...};          // Full tenant object
  session?: Session;       // Set by session validation
  userId?: string;         // Extracted from session
  firebaseUser?: {...};     // Firebase user context (sign-in flow)
}
```

### Current Auth Implementation Status

**Already Working:**

- ✅ `src/hooks.server.ts` resolves tenant from subdomain
- ✅ `src/hooks.server.ts` validates session_id cookie
- ✅ `src/hooks.server.ts` sets locals.session, locals.userId
- ✅ `src/routes/admin/+page.server.ts` has session checks
- ✅ Sign-in/sign-up pages use Firebase auth

**Needs Replacement:**

1. **`src/routes/admin/settings/school-admins/+page.server.ts`:**
   - Line 9: `const tenantId = 'placeholder-tenant-id';`
   - Line 33: `const tenantId = 'placeholder-tenant-id';` (createAdmin)
   - Line 60: `const tenantId = 'placeholder-tenant-id';` (assignRole)
   - Line 82: `const tenantId = 'placeholder-tenant-id';` (revokeAccess)
   - Missing: session validation, role checks

2. **`src/routes/admin/settings/admission-paths/+page.server.ts`:**
   - Line 9: `const MOCK_TENANT_ID = 'tenant-123';`
   - Used in load and all actions (create, update, delete, publish, close, reopen, archive)
   - Missing: session validation, role checks

3. **`src/routes/admin/settings/fee-structures/+page.server.ts`:**
   - Line 11: `const MOCK_TENANT_ID = '550e8400-e29b-41d4-a716-446655440000';`
   - Used in load and all actions (createFee, updateFee, deleteFee)
   - Missing: session validation, role checks

4. **`src/routes/admin/settings/+page.server.ts`:**
   - Already has session checks (lines 11, 37)
   - Uses `locals.tenantId` correctly
   - ⚠️ Verify: Ensure this is working correctly after middleware changes

### Technical Requirements

**Authorization Pattern (to implement):**

```typescript
// src/lib/server/auth/authorization.ts
import { redirect, error as svelteError } from '@sveltejs/kit';
import type { Session } from './types';

export interface AuthContext {
	session: Session;
	userId: string;
	tenantId: string;
}

export function requireAuth(locals: App.Locals): AuthContext {
	if (!locals.session || !locals.userId) {
		throw redirect(302, '/sign-in');
	}

	return {
		session: locals.session,
		userId: locals.userId,
		tenantId: locals.tenantId || locals.session.tenantId
	};
}

export function requireRole(auth: AuthContext, ...allowedRoles: string[]): void {
	// TODO: Implement role checking once users table has role field
	// For now, assume authenticated users have admin access
	// This will be enhanced in Story 2.5.3
}
```

**Usage Pattern in Server Actions:**

```typescript
export const actions = {
	updateProfile: async ({ request, locals }) => {
		// Validate session and tenant
		const { userId, tenantId } = requireAuth(locals);

		// Use tenantId from context
		const updatedProfile = await updateSchoolProfile(db, tenantId, validation.data);
		// ...
	}
};
```

**Usage Pattern in Load Functions:**

```typescript
export const load: PageServerLoad = async ({ locals }) => {
	const { userId, tenantId } = requireAuth(locals);

	const paths = await admissionPathsDomain.listAdmissionPaths(db, tenantId);
	return { paths };
};
```

### Tenant Isolation Enforcement

**Critical Rule:** All database queries MUST use `tenantId` from session context.

**Verification Checklist:**

- [ ] Every SELECT query filters by tenantId
- [ ] Every INSERT includes tenantId
- [ ] Every UPDATE/DELETE filters by tenantId
- [ ] Domain layer functions enforce tenantId parameter
- [ ] No hardcoded tenant IDs remain

**Example from Story 2.5.1 (correct pattern):**

```typescript
// src/routes/admin/+page.server.ts
export const load: PageServerLoad = async ({ locals }) => {
	if (!locals.session) {
		throw redirect(302, '/sign-in');
	}
	// Tenant from locals.tenantId (set by subdomain resolution)
	const tenants = await listTenants();
	return { tenants };
};
```

### Session Refresh Strategy

**When to Refresh Sessions:**

- Active admin routes (dashboard, settings pages)
- On successful form submissions (actions)
- Periodically on long-lived sessions

**Implementation:**

```typescript
import { refreshSession } from '$lib/server/auth/session';

// In middleware or route handlers
if (locals.session && shouldRefresh(locals.session)) {
	const refreshed = await refreshSession(locals.session.id, SESSION_EXPIRY);
	if (refreshed) {
		locals.session = refreshed;
	}
}
```

### Error Handling Patterns

**401 Unauthorized (Invalid Session):**

```typescript
export const load: PageServerLoad = async ({ locals }) => {
	if (!locals.session || !locals.userId) {
		throw redirect(302, '/sign-in');
	}
	// ...
};
```

**403 Forbidden (Wrong Role):**

```typescript
// TODO: Implement in Story 2.5.3
export const updatePath: Action = async ({ locals }) => {
	const { session, userId, tenantId } = requireAuth(locals);
	requireRole(session, 'admin', 'verifier');

	// Proceed with operation
};
```

**Session Expired:**

- Middleware already handles: clears invalid session_id cookie
- Routes check `locals.session` and redirect to `/sign-in`

### Testing Standards Summary

**TDD Approach Required:**

1. Write tests FIRST, then implement
2. Each task should have corresponding test coverage

**Test Types:**

- **Unit Tests** (`tests/unit/authorization.test.ts`):
  - `requireAuth()` with valid session
  - `requireAuth()` with missing session (throws redirect)
  - `requireRole()` with allowed roles
  - `requireRole()` with forbidden roles

- **Integration Tests** (`tests/integration/session-protected-routes.test.ts`):
  - Access admin route without session (401)
  - Access admin route with valid session (200)
  - Access other tenant's data (403)
  - Session refresh on active route

- **E2E Tests** (`e2e/admin-auth.test.ts`):
  - Sign in flow
  - Navigate to admin routes
  - Perform CRUD operations
  - Session expiration handling

**Test Coverage Goals:**

- Authorization helper: 95%+ coverage
- Session-protected routes: 90%+ coverage
- Tenant isolation: 100% coverage (critical)

### Anti-Patterns to Avoid

❌ **DO NOT** use hardcoded tenant IDs or mock values
❌ **DO NOT** skip session validation in server actions
❌ **DO NOT** rely solely on client-side validation
❌ **DO NOT** break tenant isolation from Story 1.3
❌ **DO NOT** use locals.tenantId without verifying locals.session exists
❌ **DO NOT** forget to clear session cookies on 401 errors
❌ **DO NOT** mix Firebase sessions directly - use custom session from `session.ts`

### Integration Points

**Existing Systems:**

- **Middleware (Story 1.3 + 2.5.1):** Must preserve tenant_id context
- **Session Management (Story 2.5.1):** Use `validateSession()`, `refreshSession()`, `invalidateSession()`
- **Domain Layer (Story 2.x):** All domain functions require `tenantId` parameter

**Files to Modify:**

```
src/routes/admin/settings/school-admins/+page.server.ts
src/routes/admin/settings/admission-paths/+page.server.ts
src/routes/admin/settings/fee-structures/+page.server.ts
src/routes/admin/settings/+page.server.ts (verify only)
src/lib/server/auth/authorization.ts (NEW)
tests/unit/authorization.test.ts (NEW)
tests/integration/session-protected-routes.test.ts (NEW)
e2e/admin-auth.test.ts (NEW or update)
```

### Success Metrics

- All mock/placeholder tenant IDs replaced with session-based tenantId
- All admin routes require valid session
- Role-based authorization checks implemented
- Tenant isolation verified in all modified routes
- Session refresh prevents premature expiration
- Expired sessions redirect to sign-in properly
- All tests passing (unit + integration + E2E)

### Dependencies

**Prerequisite:**

- Story 2.5.1 MUST be completed (Firebase + WAHA hybrid auth, session management, middleware integration)

**Blocked By:**

- None (Story 2.5.1 is in 'review' status)

**Next Stories:**

- Story 2.5.3: Update All Permission Checking Helpers (will enhance role checks)
- Story 2.5.4: Test Auth Flow End-to-End

## References

- **Story 2.5.1:** Firebase + WAHA Hybrid Authentication Integration [Source: /_bmad-output/implementation-artifacts/2.5.1-firebase-waha-hybrid-authentication-integration.md]
- **Story 1.3:** Subdomain Resolution & Routing - MUST preserve tenant_id context [Source: /_bmad-output/implementation-artifacts/1-3-subdomain-resolution-routing.md]
- **Story 1.2:** Tenant Database Isolation (RLS) - Session must work with RLS [Source: /_bmad-output/implementation-artifacts/1-2-tenant-database-isolation-rls.md]
- **Architecture:** Custom Auth Logic with session caching in Cloudflare KV [Source: /_bmad-output/planning-artifacts/architecture.md#Authentication & Security]
- **Sprint Status:** Epic 2.5 stories and progress tracking [Source: /_bmad-output/sprint-status.yaml]

## Dev Agent Record

### Agent Model Used

Claude (Anthropic)

### Completion Notes List

- **Story Context:** This story builds directly on Story 2.5.1 which implemented the Firebase + WAHA hybrid auth system. The session management infrastructure is complete and ready for integration into all admin routes.
- **Auth Placeholder Analysis:** Identified 6+ locations with mock/placeholder auth that need replacement across 4 admin route files.
- **Role-Based Authorization:** Basic role checks will be implemented now, with full permission matrix coming in Story 2.5.3.
- **Tenant Isolation:** Critical to verify that all queries use `locals.tenantId` from session context to maintain tenant isolation from Story 1.3.
- **Session Refresh:** Will implement selective refresh on active routes to prevent premature expiration during admin work.

**Implementation Strategy:**

1. Create authorization helper module for reusable auth checks
2. Systematically replace all mock/placeholder values with session-based context
3. Add session validation to all load functions and server actions
4. Implement role-based authorization for sensitive operations
5. Add session refresh logic to active admin routes
6. Comprehensive testing (unit, integration, E2E)

**Key Files to Modify:**

- `src/routes/admin/settings/school-admins/+page.server.ts` - 4 placeholder replacements + auth checks
- `src/routes/admin/settings/admission-paths/+page.server.ts` - Replace MOCK_TENANT_ID + auth checks
- `src/routes/admin/settings/fee-structures/+page.server.ts` - Replace MOCK_TENANT_ID + auth checks
- `src/routes/admin/settings/+page.server.ts` - Verify existing auth implementation

**New Files to Create:**

- `src/lib/server/auth/authorization.ts` - Reusable authorization helpers
- `tests/unit/authorization.test.ts` - Unit tests for authorization logic
- `tests/integration/session-protected-routes.test.ts` - Integration tests

### File List

**New Files:**

- src/lib/server/auth/authorization.ts
- tests/unit/authorization.test.ts
- tests/integration/session-protected-routes.test.ts
- e2e/admin-auth.test.ts (or update existing)

**Modified Files:**

- src/routes/admin/settings/school-admins/+page.server.ts
- src/routes/admin/settings/admission-paths/+page.server.ts
- src/routes/admin/settings/fee-structures/+page.server.ts
- src/routes/admin/settings/+page.server.ts (verification only)

**No Database Changes Required:**

- Sessions table already exists (migration 0005 from Story 2.5.1)
- Users table already exists (from Epic 1)
- No new migrations needed

**Environment Variables Required:**

- None new - all auth environment variables from Story 2.5.1 (FIREBASE_PROJECT_ID, FIREBASE_PRIVATE_KEY, FIREBASE_CLIENT_EMAIL, WAHA_BASE_URL, WAHA_SESSION)
